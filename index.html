<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Starbucks In Korea</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
  integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
  crossorigin=""/>
  <link rel="stylesheet" href="https://rawgit.com/leongersen/noUiSlider/master/distribute/nouislider.min.css">
  <style>
  html,body {
    width: 100%;
    height: 100%;
    padding: 0;
    margin: 0;
  }
  #map {
    width: 100%;
    height: 100%;
  }
  button {
    width: 100%;
    margin-bottom: 20px;
  }
  .container {
    width: 300px;
    padding: 10px 20px 40px 20px;
    background-color: white;
  }
  .slider-wrapper {
    margin-bottom: 40px;
  }
  /* noUISlider override */
  .noUi-horizontal {
    height: 10px;
  }
  .noUi-horizontal .noUi-handle {
    height: 20px;
  }
  .noUi-handle:after, .noUi-handle:before {
    content: none;
  }
  .noUi-connect {
    background: #ccc;
    outline: 1px solid #333;
  }
  /* I am so lazy, let's just use the slider as legend */
  .scale-slider-wrapper .noUi-base {
    background-image: linear-gradient(
                        to right,
                        /*rgb(255,255,178),
                        rgb(255,255,178) 25%,*/
                        rgb(254,217,118),
                        rgb(254,217,118) 25%,
                        rgb(254,178,76) 25%,
                        rgb(254,178,76) 50%,
                        rgb(253,141,60) 50%,
                        rgb(253,141,60) 75%,
                        rgb(252,78,42) 75%,
                        rgb(252,78,42)
      /*                  rgb(227,26, 28) 62.5%,
                        rgb(227,26, 28) 75%,
                        rgb(177,0,38)*/
                      );
  }
  .scale-slider-wrapper .noUi-connect {
    background: transparent;
    outline: 1px solid #333;
  }
  h3 {
    margin-top: 0;
  }
  label {
    font-size: 14px;
    font-weight: 700;
  }
  </style>
</head>
<body>
  <div id="map">
  </div>
  <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
  integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
  crossorigin=""></script>
  <script src="https://unpkg.com/tangram@0.15.1/dist/tangram.min.js"></script>
  <script src="https://rawgit.com/leongersen/noUiSlider/master/distribute/nouislider.js"></script>
  <script>
    /* ahahahaha */
    var times = ["2018051323","2018051322","2018051321","2018051320","2018051319","2018051318","2018051317","2018051316","2018051315","2018051314","2018051313","2018051312","2018051311","2018051310","2018051309","2018051308","2018051307","2018051306","2018051305","2018051304","2018051303","2018051302","2018051301","2018051300","2018051223","2018051222","2018051221","2018051220","2018051219","2018051218","2018051217","2018051216","2018051215","2018051214","2018051213","2018051212","2018051211","2018051210","2018051209","2018051208","2018051207","2018051206","2018051205","2018051204","2018051203","2018051202","2018051201","2018051200","2018051123","2018051122","2018051121","2018051120","2018051119","2018051118","2018051117","2018051116","2018051115","2018051114","2018051113","2018051112","2018051111","2018051110","2018051109","2018051108","2018051107","2018051106","2018051105","2018051104","2018051103","2018051102","2018051101","2018051100","2018050623","2018050622","2018050621","2018050620","2018050619","2018050618","2018050617","2018050616","2018050615","2018050614","2018050613","2018050612","2018050611","2018050610","2018050609","2018050608","2018050607","2018050606","2018050605","2018050604","2018050603","2018050602","2018050601","2018050600","2018050523","2018050522","2018050521","2018050520","2018050519","2018050518","2018050517","2018050516","2018050515","2018050514","2018050513","2018050512","2018050511","2018050510","2018050509","2018050508","2018050507","2018050506","2018050505","2018050504","2018050503","2018050502","2018050501","2018050500","2018050423","2018050422","2018050421","2018050420","2018050419","2018050418","2018050417","2018050416","2018050415","2018050414","2018050413","2018050412","2018050411","2018050410","2018050409","2018050408","2018050407","2018050406","2018050405","2018050404","2018050403","2018050402","2018050401","2018050400","2018050323","2018050322","2018050321","2018050320","2018050319","2018050318","2018050317","2018050316","2018050315","2018050314","2018050313","2018050312","2018050311","2018050310","2018050309","2018050308","2018050307","2018050306","2018050305","2018050304","2018050303","2018050302","2018050301","2018050300","2018050223","2018050222","2018050221","2018050220","2018050219","2018050218","2018050217","2018050216","2018050215","2018050214","2018050213","2018050212","2018050211","2018050210","2018050209","2018050208","2018050207","2018050206","2018050205","2018050204","2018050203","2018050202","2018050201","2018050200","2018050123","2018050122","2018050121","2018050120","2018050119","2018050118","2018050117","2018050116","2018050115","2018050114","2018050113","2018050112","2018050111","2018050110","2018050109","2018050108","2018050107","2018050106","2018050105","2018050104","2018050103","2018050102","2018050101","2018050100","2018043023","2018043022","2018043021","2018043020","2018043019","2018043018","2018043017","2018043016","2018043015","2018043014","2018043013","2018043012","2018043011","2018043010","2018043009","2018043008","2018043007","2018043006","2018043005","2018043004","2018043003","2018043002","2018043001","2018043000","2018042923","2018042922","2018042921","2018042920","2018042919","2018042918","2018042917","2018042916","2018042915","2018042914","2018042913","2018042912","2018042911","2018042910","2018042909","2018042908","2018042907","2018042906","2018042905","2018042904","2018042903","2018042902","2018042901","2018042900","2018042823","2018042822","2018042821","2018042820","2018042819","2018042818","2018042817","2018042816","2018042815","2018042814","2018042813","2018042812","2018042811","2018042810","2018042809","2018042808","2018042807","2018042806","2018042805","2018042804","2018042803","2018042802","2018042801","2018042800","2018042723","2018042722","2018042721","2018042720","2018042719","2018042718","2018042717","2018042716","2018042715","2018042714","2018042713","2018042712","2018042711","2018042710","2018042709","2018042708","2018042707","2018042706","2018042705","2018042704","2018042703","2018042702","2018042701","2018042700","2018042623","2018042622","2018042621","2018042620","2018042619","2018042618","2018042617","2018042616","2018042615","2018042614","2018042613","2018042612","2018042611","2018042610","2018042609","2018042608","2018042607","2018042606","2018042605","2018042604","2018042603","2018042602","2018042601","2018042600","2018042523","2018042522","2018042521","2018042520","2018042519","2018042518","2018042517","2018042516","2018042515","2018042514","2018042513","2018042512","2018042511","2018042510","2018042509","2018042508","2018042507","2018042506","2018042505","2018042504","2018042503","2018042502","2018042501","2018042500","2018042423","2018042422","2018042421","2018042420","2018042419","2018042418","2018042417","2018042416","2018042415","2018042414","2018042413","2018042412","2018042411","2018042410","2018042409","2018042408","2018042407","2018042406","2018042405","2018042404","2018042403","2018042402","2018042401","2018042400","2018042323","2018042322","2018042321","2018042320","2018042319","2018042318","2018042317","2018042316","2018042315","2018042314","2018042313","2018042312","2018042311","2018042310","2018042309","2018042308","2018042307","2018042306","2018042305","2018042304","2018042303","2018042302","2018042301","2018042300","2018042223","2018042222","2018042221","2018042220","2018042219","2018042218","2018042217","2018042216","2018042215","2018042214","2018042213","2018042212","2018042211","2018042210","2018042209","2018042208","2018042207","2018042206","2018042205","2018042204","2018042203","2018042202","2018042201","2018042200","2018042123","2018042122","2018042121","2018042120","2018042119","2018042118","2018042117","2018042116","2018042115","2018042114","2018042113","2018042112","2018042111","2018042110","2018042109","2018042108","2018042107","2018042106","2018042105","2018042104","2018042103","2018042102","2018042101","2018042100","2018042023","2018042022","2018042021","2018042020","2018042019","2018042018","2018042017","2018042016","2018042015","2018042014","2018042013","2018042012","2018042011","2018042010","2018042009","2018042008","2018042007","2018042006","2018042005","2018042004","2018042003","2018042002","2018042001","2018042000","2018041923","2018041922","2018041921","2018041920","2018041919","2018041918","2018041917","2018041916","2018041915","2018041914","2018041913","2018041912","2018041911","2018041910","2018041909","2018041908","2018041907","2018041906","2018041905","2018041904","2018041903","2018041902","2018041901","2018041900","2018041823","2018041822","2018041821","2018041820","2018041819","2018041818","2018041817","2018041816","2018041815","2018041814","2018041813","2018041812","2018041811","2018041810","2018041809","2018041808","2018041807","2018041806","2018041805","2018041804","2018041803","2018041802","2018041801","2018041800"]

    times.reverse();

    var dateSliderMin = 0;
    var dateSliderMax = times.length-1;
    var slidingAnimValue = 0;

    var currentTime = times[0];


    var map = L.map('map');

    map.setView([37.58451, 126.96939], 12);

    var tangramLayer = Tangram.leafletLayer({
      scene: {
        import: './timeline.yaml',
        global: {
          minDateRange: dateSliderMin,
          maxDateRange: dateSliderMax,
       }
     },
     events: {
       click: function(selection) {
         onTangramClick(selection)
       }
     }
    })

    tangramLayer.addTo(map)

    var makeCurrentPopulationTr = function(obj) {
      var tableRowElem = document.createElement('tr');
      var nameColElem = document.createElement('td');
      var valueColElem = document.createElement('td');

      var currentTime = times[Math.floor(slidingAnimValue)];

      var currentString = times[currentTime];

      nameColElem.textContent = getDisplayText(currentTime);
      valueColElem.textContent = obj[currentTime];

      tableRowElem.appendChild(nameColElem);
      tableRowElem.appendChild(valueColElem);
      return tableRowElem;
    }

    var jsonToTable = function (obj) {
      var wrapperTableElem = document.createElement('table');
      wrapperTableElem.classList.add('feature-table');
      for (var key in obj) {
          if (key !== 'population') {
            var tableRowElem = document.createElement('tr');
            var nameColElem = document.createElement('td');
            var valueColElem = document.createElement('td');
            nameColElem.textContent = key;
            valueColElem.textContent = obj[key];
            tableRowElem.appendChild(nameColElem);
            tableRowElem.appendChild(valueColElem);
            wrapperTableElem.appendChild(tableRowElem);
        }
      }
      var populationElem = makeCurrentPopulationTr(obj['population']);
      wrapperTableElem.appendChild(populationElem);
      return wrapperTableElem;
    }

    var onTangramClick = function (selection) {
      if (selection.feature) {
        var popup = L.popup()
                  .setLatLng(selection.leaflet_event.latlng)
                  .setContent(jsonToTable(selection.feature.properties))
                  .openOn(map);
      }
    }

    var first = false;
    var animate = function (slid, timeH) {
        // slid.set(slidingAnimValue);
        console.log(slidingAnimValue);
        updateTangram(slidingAnimValue);
        currentTime = times[slidingAnimValue];
         timeH.textContent = getDisplayText(times[Math.floor(slidingAnimValue)]);
          if (slidingAnimValue < dateSliderMax) {
            slidingAnimValue+=0.1;
          }
          else {
            slidingAnimValue = 0;
          }
    }

    var setAnimation = function(slid, timeH) {
      setInterval(function() {
        animate(slid,timeH)
      }, 50);
    }

    var updateTangram = function(idx) {
      tangramLayer.scene.styles.dongStyle.shaders.uniforms.u_offset = idx;
    }

    var sliderControl = L.control({position: 'topright'});

    sliderControl.onAdd = function () {
      var containerDiv = L.DomUtil.create('div', 'container');
      var titleH = L.DomUtil.create('h3');
      titleH.textContent = 'Populations in Seoul';
      var timeH = L.DomUtil.create('h4');

      var sliderDiv = L.DomUtil.create('div', 'slider-wrapper');
      var dateLabel = L.DomUtil.create('label');
      dateLabel.textContent = 'Year';

      sliderDiv.id = 'slider';
      noUiSlider.create(sliderDiv, {
        start: 0,
        connect: true,
        step: 0.1,
        tooltips: false,
        range: {
          'min': dateSliderMin,
          'max': dateSliderMax
        },
        format: {
          to: function (value) {
            return value;
          },
          from: function (value) {
            return value;
          }
        },
        pips: { // Show a scale with the slider
          mode: 'positions',
          stepped: true,
          density: 20,
          values: [0,25,50,75,100]
        }
      });


      var scaleLabel = L.DomUtil.create('label');
      scaleLabel.innerHTML = 'Scale(<a href="https://en.wikipedia.org/wiki/Mercalli_intensity_scale">MI</a>)';


      var playButton = L.DomUtil.create('button');
      playButton.textContent = 'play';

      playButton.onclick = function () {
        slidingAnimValue = 0;
        setAnimation(sliderDiv.noUiSlider, timeH);
      }

      sliderDiv.noUiSlider.on('change', function ( values, handle ) {
        console.log('onchange')
        let idx = Math.ceil([values[handle]]);
        currentTime = times[idx];
        updateTangram(idx);
        timeH.textContent = getDisplayText(currentTime);
      });

      L.DomEvent.disableClickPropagation(containerDiv);

      containerDiv.appendChild(titleH);
      containerDiv.appendChild(playButton);
      containerDiv.appendChild(dateLabel);
      containerDiv.appendChild(sliderDiv);
      containerDiv.appendChild(timeH);


      return containerDiv;
    }

    function getDisplayText(s) {
      return s[0]+s[1]+s[2]+s[3]+'/ '+s[4]+s[5] + '/ ' + s[6] +s[7] + '  '+ s[8]+s[9]+'ì‹œ';
    }

    sliderControl.addTo(map);


  </script>
</body>
</html>
